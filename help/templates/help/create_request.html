{% extends "help/base.html" %}
{% load custom_filters %}

{% block title %}Создать запрос - Портал помощи{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 30px; color: #0ea5e9;">Создать запрос помощи</h2>
    
    <form method="POST" id="requestForm">
        {% csrf_token %}
        
        <!-- Общие поля в одну строку -->
        <div style="background: #f8fafc; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
            <h3 style="margin-bottom: 20px; color: #1f2937; font-size: 18px;">Общая информация</h3>
            
            <div class="form-row">
                {% for field in initial_fields %}
                <div class="form-group">
                    <label for="id_{{ field.field_key }}">
                        {{ field.name }}
                        {% if field.required %}<span style="color: #ef4444;">*</span>{% endif %}
                    </label>
                    
                    {% if field.field_type == 'textarea' %}
                        <textarea 
                            name="{{ field.field_key }}" 
                            id="id_{{ field.field_key }}"
                            placeholder="{{ field.placeholder }}"
                            {% if field.required %}required{% endif %}
                        ></textarea>
                    {% elif field.field_type == 'email' %}
                        <input 
                            type="email" 
                            name="{{ field.field_key }}" 
                            id="id_{{ field.field_key }}"
                            placeholder="{{ field.placeholder }}"
                            {% if field.required %}required{% endif %}
                        >
                    {% elif field.field_type == 'date' %}
                        <input 
                            type="date" 
                            name="{{ field.field_key }}" 
                            id="id_{{ field.field_key }}"
                            {% if field.required %}required{% endif %}
                        >
                    {% elif field.field_type == 'number' %}
                        <input 
                            type="number" 
                            name="{{ field.field_key }}" 
                            id="id_{{ field.field_key }}"
                            placeholder="{{ field.placeholder }}"
                            {% if field.required %}required{% endif %}
                        >
                    {% else %}
                        <input 
                            type="text" 
                            name="{{ field.field_key }}" 
                            id="id_{{ field.field_key }}"
                            placeholder="{{ field.placeholder }}"
                            {% if field.required %}required{% endif %}
                        >
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Выбор категории -->
        <div class="form-group" style="margin-bottom: 30px;">
            <label for="help_category" style="font-size: 18px;">
                Выберите вид помощи <span style="color: #ef4444;">*</span>
            </label>
            <select 
                name="help_category" 
                id="help_category" 
                required
                style="font-size: 16px; padding: 15px;"
            >
                <option value="">-- Выберите категорию --</option>
                {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Дополнительные поля (загружаются динамически) -->
        <div id="customFieldsContainer" style="display: none;">
            <div style="background: #f0f9ff; padding: 25px; border-radius: 12px; border-left: 4px solid #0ea5e9;">
                <h3 style="margin-bottom: 20px; color: #0c4a6e; font-size: 18px;" id="categoryTitle">
                    Дополнительная информация
                </h3>
                
                <div class="form-row" id="customFields"></div>
            </div>
        </div>
        
        <div style="margin-top: 30px; display: flex; gap: 15px;">
            <button type="submit" class="btn btn-primary" style="font-size: 16px; padding: 15px 40px;">
                Отправить запрос
            </button>
            <a href="{% url 'index' %}" class="btn btn-secondary" style="font-size: 16px; padding: 15px 40px;">
                Отмена
            </a>
        </div>
    </form>
</div>

<script>
document.getElementById('help_category').addEventListener('change', function() {
    const categoryId = this.value;
    const container = document.getElementById('customFieldsContainer');
    const fieldsDiv = document.getElementById('customFields');
    const categoryTitle = document.getElementById('categoryTitle');
    
    if (!categoryId) {
        container.style.display = 'none';
        return;
    }
    
    // Получаем поля для выбранной категории
    fetch(`/api/category/${categoryId}/fields/`)
        .then(response => response.json())
        .then(data => {
            fieldsDiv.innerHTML = '';
            
            if (data.fields && data.fields.length > 0) {
                const categoryName = this.options[this.selectedIndex].text;
                categoryTitle.textContent = `Дополнительная информация: ${categoryName}`;
                
                data.fields.forEach(field => {
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';
                    
                    const label = document.createElement('label');
                    label.textContent = field.name;
                    if (field.required) {
                        const required = document.createElement('span');
                        required.style.color = '#ef4444';
                        required.textContent = ' *';
                        label.appendChild(required);
                    }
                    formGroup.appendChild(label);
                    
                    let input;
                    
                    if (field.field_type === 'textarea') {
                        input = document.createElement('textarea');
                        input.style.minHeight = '100px';
                    } else if (field.field_type === 'choice') {
                        input = document.createElement('select');
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = '-- Выберите --';
                        input.appendChild(defaultOption);
                        
                        field.choices.forEach(choice => {
                            const option = document.createElement('option');
                            option.value = choice;
                            option.textContent = choice;
                            input.appendChild(option);
                        });
                    } else if (field.field_type === 'date') {
                        input = document.createElement('input');
                        input.type = 'date';
                    } else if (field.field_type === 'number') {
                        input = document.createElement('input');
                        input.type = 'number';
                    } else if (field.field_type === 'email') {
                        input = document.createElement('input');
                        input.type = 'email';
                    } else {
                        input = document.createElement('input');
                        input.type = 'text';
                    }
                    
                    input.name = field.field_key;
                    input.id = `id_${field.field_key}`;
                    if (field.placeholder) {
                        input.placeholder = field.placeholder;
                    }
                    if (field.required) {
                        input.required = true;
                    }
                    
                    formGroup.appendChild(input);
                    fieldsDiv.appendChild(formGroup);
                });
                
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            container.style.display = 'none';
        });
});
</script>
{% endblock %}